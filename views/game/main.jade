extends layout

block content
  h1= title
  p Welcome to #{title}

  div.create-user
    form.create-user-form
      label.username-label Username
        input.username
      input(type="submit", value="Create User")

  div.game-information.hidden
    ul.player-list

  div.games-list-container.hidden
    ul.games-list
    form.new-game-form
      label.game-name-label Game name
        input.game-name
      input(type="submit", value="Create Game")

  table.game-board.hidden
    tr.categories

  div.json-dump.hidden
    p= JSON.stringify(result.categories)

  :coffeescript
    socket = io.connect(window.location.hostname)

    socket.on "update player list", (players) ->
      $player_list = $(".player-list")
      $player_list.empty()
      htmlString = ""

      _.each players, (player) ->
        htmlString += "<li>#{player.username}</li>"

      $player_list.html(htmlString)

    socket.on "update games list", (games) ->
      $games_list = $(".games-list")
      $games_list.empty()
      htmlString = ""

      _.each games, (game) ->
        htmlString += "<li>#{game.game_name}</li>"

      $games_list.html(htmlString)

    $ ->
      $(".create-user-form").on "submit", (e) ->
        e.preventDefault()

        $create_user = $(".create-user")
        $game_information = $(".game-information")
        $games_list_container = $(".games-list-container")
        $username = $create_user.find(".username")
        username = $username.val()

        socket.emit "new player", {username: username}
        $create_user.hide()
        $game_information.removeClass "hidden"
        $games_list_container.removeClass "hidden"

      $(".new-game-form").on "submit", (e) ->
        e.preventDefault()

        $new_game = $(".new-game-form")
        $game_name = $new_game.find(".game-name")
        game_name = $game_name.val()
        socket.emit "new game", {game_name: game_name}

    # LOGIC TO CREATE THE JEOPARDY BOARD
      $categories = $("tr.categories")
      categories = JSON.parse($(".json-dump p").text())
      clues = []
      $game_board = $(".game-board")

      _.each categories, (category) ->
        $categories.append("<td class='category-name'>#{category.name} (#{category.date_part})</td>")
        temp_clue_array = []
        _.each category.clues, (clue) ->
          temp_clue_array.push clue
        clues.push temp_clue_array

      clues = _.zip(clues[0], clues[1], clues[2], clues[3], clues[4], clues[5])
      _.each clues, (row, index) ->
        $game_board.append("<tr class='row#{index+1}'></tr>")
        _.each row, (clue) ->
          $("tr.row#{index+1}").append("<td class='clue' data-state='value'><p><span class='value'>#{clue.value}</span><span class='question'>#{clue.question}</span><span class='answer'>#{clue.answer}</span></td>")

    # LOGIC TO INTERACT WITH THE JEOPARDY BOARD
      $("td.clue").on "click", (e) ->
        switch $(this).attr("data-state")
          when "value"
            $(this).find(".value").hide()
            $(this).find(".question").show()
            $(this).attr("data-state", "question")
          when "question"
            $(this).find(".question").hide()
            $(this).find(".answer").show()
            $(this).attr("data-state", "answer")
